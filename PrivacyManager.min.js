"use strict";function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}var PrivacyManager=function(){function o(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,o),this.defaults={expDays:"Thu, 01 Jan 1970 00:00:00 GMT",saveAsCookie:!0,cookieExp:365,savePreferences:!0,key:"privacy-preferences",form:null,on:{init:null,update:null,restore:null},items:[]},this.props=this.mergeDeep(this.defaults,e),this.savedPreferences=[];var t=this.props.form;if(!(t instanceof Element&&t))throw new Error('"form" should be DOM object');this.init=this.init.bind(this),this.updateFromSave=this.updateFromSave.bind(this),this.updatePreferences=this.updatePreferences.bind(this),this.updateSaved=this.updateSaved.bind(this),this.perfomAction=this.performAction.bind(this),this.restoreDefaults=this.restoreDefaults.bind(this),this.fetchCookies=this.fetchCookies.bind(this),this.addCookie=this.addCookie.bind(this),this.getCookie=this.getCookie.bind(this),this.deleteCookie=this.deleteCookie.bind(this),this.payload=this.payload.bind(this),this.formatted=this.fetchCookies(),this.init()}return _createClass(o,[{key:"init",value:function(){var e=this.getCookie(this.props.key),t=localStorage.getItem(this.props.key);this.props.saveAsCookie&&(this.savedPreferences=e?JSON.parse(e.content):[],t&&localStorage.removeItem(this.props.key)),this.props.saveAsCookie||(this.savedPreferences=t?JSON.parse(t):[],e&&this.deleteCookie(this.props.key)),this.props.form.addEventListener("submit",this.updatePreferences,!1),0<this.savedPreferences.length&&this.updateFromSave(),this.updatePreferences(),this.payload(this.props.on.init)}},{key:"updateFromSave",value:function(){var o=this.props.form;this.savedPreferences.forEach(function(e){var t=o[e.name];t&&(t.checked=e.checked)})}},{key:"payload",value:function(e){var t=this.props.saveAsCookie,o=t?this.getCookie(this.props.key):localStorage.getItem(this.props.key),i=null;o&&(i=t?o.content:o);var s={form:this.props.form,id:this.props.key,data:i?JSON.parse(i):[]};e&&e(s)}},{key:"updatePreferences",value:function(e){var o=this;e&&e.preventDefault();var i=this.props.form;this.savedPreferences=[],this.props.items.forEach(function(e){var t=e.name;t&&i[t]&&o.performAction(i[t].checked,e)}),this.props.savePreferences&&this.updateSaved(),this.payload(this.props.on.update)}},{key:"updateSaved",value:function(){var e=this.props.cookieExp,t=this.props.key;this.props.saveAsCookie?this.addCookie(t,JSON.stringify(this.savedPreferences),e):localStorage.setItem(t,JSON.stringify(this.savedPreferences))}},{key:"performAction",value:function(e,t){var o=e||!1,i=t.onApprove,s=t.onDeny,r={name:t.name,checked:o};this.savedPreferences.push(r),o?i&&i(r):s&&s(r),t.onAction&&t.onAction(r)}},{key:"restoreDefaults",value:function(){var i=this,s=this.props.form,e=this.props.items;this.props.saveAsCookie?this.deleteCookie(this.props.key):localStorage.removeItem(this.props.key);var r=[];e.forEach(function(e){var t,o=s[e.name];o&&(t={name:e.name,checked:e.checked},r.push(t),o.checked=e.checked,i.performAction(s[e.name].checked,e))}),this.savedPreferences=r,this.props.savePreferences&&this.updateSaved(),this.payload(this.props.on.restore)}},{key:"fetchCookies",value:function(){var e=document.cookie.split(";"),r=[];return e.forEach(function(e){var t=e.trim(),o=t.split("=")[0],i=t.split("=");i.shift();var s={name:o,content:i=i.join("=")};r.push(s)}),r}},{key:"addCookie",value:function(e,t,o,i){var s=2<arguments.length&&void 0!==o?o:365,r=3<arguments.length&&void 0!==i?i:"";if(!e||!t)return this;var n=new Date;return n.setTime(n.getTime()+24*s*60*60*1e3),document.cookie="".concat(e,"=").concat(t,";expires=").concat(n.toUTCString(),";").concat(r,"path=/"),this.formatted=this.fetchCookies(),this}},{key:"getCookie",value:function(e){var t=0<arguments.length&&void 0!==e?e:"",o=this.formatted.filter(function(e){return e.name===t});return 0===o.length?null:o[0]}},{key:"deleteCookie",value:function(e){var t=0<arguments.length&&void 0!==e?e:"",o=this.getCookie(t);return o?(document.cookie="".concat(o.name,"='';expires=").concat(this.props.expDays,";path=/"),this.formatted=this.fetchCookies(),o):null}},{key:"mergeDeep",value:function(t,o){var i=this;function s(e){return e&&"object"===_typeof(e)&&!Array.isArray(e)&&null!==e}return s(t)&&s(o)&&Object.keys(o).forEach(function(e){s(o[e])?(t[e]&&s(t[e])||(t[e]=o[e]),i.mergeDeep(t[e],o[e])):Object.assign(t,_defineProperty({},e,o[e]))}),t}},{key:"getProps",get:function(){return this.props}}]),o}();